
@page "/payment/success"
@inject IStringLocalizer<SharedResource> L
@inject IPhotoCreditService PhotoCreditService
@inject NavigationManager NavigationManager
@inject IToastService ToastService
@inject IJSRuntime JSRuntime

<PageTitle>@L["PaymentSuccess"] - @L["AppName"]</PageTitle>

<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
                <Card Background="Background.Success" TextColor="TextColor.White" MClass="mb-4">   
                <CardBody>
                    <div class="text-center">
                        <Icon Name="IconName.CheckCircle" Style="font-size: 4rem;" />
                        <h2 class="mt-3">@L["PaymentSuccessful"]</h2>
                        <p class="lead">
                            @if (CultureInfo.CurrentCulture.Name.StartsWith("es"))
                            {
                                <span>¡Su compra ha sido completada con éxito!</span>
                            }
                            else
                            {
                                <span>Your purchase has been completed successfully!</span>
                            }
                        </p>
                    </div>
                </CardBody>
            </Card>

            <Card>
                <CardBody>
                    @if (isLoading)
                    {
                        <div class="d-flex justify-content-center">
                            <Spinner Color="Color.Primary" Size="Size.Large" />
                        </div>
                    }
                    else if (hasError)
                    {
                        <Alert Color="Color.Warning">
                            <AlertMessage>
                                @if (CultureInfo.CurrentCulture.Name.StartsWith("es"))
                                {
                                    <span>Hubo un problema al procesar su pago. Los créditos pueden tardar hasta 15 minutos en aparecer en su cuenta. Si después de este tiempo no ve sus créditos, contacte a soporte.</span>
                                }
                                else
                                {
                                    <span>There was an issue processing your payment. Credits may take up to 15 minutes to appear in your account. If after this time you don't see your credits, please contact support.</span>
                                }
                            </AlertMessage>
                        </Alert>
                    }
                    else
                    {
                        <div class="text-center mb-4">
                            <h4>@L["PurchaseDetails"]</h4>
                            <div class="row mt-4">
                                <div class="col-md-6 text-md-end">
                                    <p><strong>@L["Credits"]:</strong></p>
                                    <p><strong>@L["Amount"]:</strong></p>
                                    <p><strong>@L["Date"]:</strong></p>
                                    <p><strong>@L["AvailableCredits"]:</strong></p>
                                </div>
                                <div class="col-md-6 text-md-start">
                                    <p>@purchase?.CreditsAmount</p>
                                    <p>$@(purchase?.Amount.ToString("N2"))</p>
                                    <p>@(purchase?.CompletedAt?.ToLocalTime().ToString("g") ?? DateTime.Now.ToString("g"))</p>
                                    <p>@availableCredits</p>
                                </div>
                            </div>
                        </div>

                        <div class="text-center">
                            <h4>@L["WhatsNext"]</h4>
                            <p>
                                @if (CultureInfo.CurrentCulture.Name.StartsWith("es"))
                                {
                                    <span>Sus créditos han sido añadidos a su cuenta y están listos para ser utilizados para analizar fotos de sus artículos de mudanza.</span>
                                }
                                else
                                {
                                    <span>Your credits have been added to your account and are ready to be used for analyzing photos of your moving items.</span>
                                }
                            </p>
                        </div>
                    }

                    <div class="d-flex justify-content-center mt-4">
                        <Button Color="Color.Primary" Clicked="@(() => NavigationManager.NavigateTo("/photo-credits"))">
                            <Icon Name="IconName.CreditCard" />
                            @L["BackToPhotoCredits"]
                        </Button>
                        <Button Color="Color.Secondary" Class="ms-2" Clicked="@(() => NavigationManager.NavigateTo("/my-moves"))">
                            <Icon Name="IconName.Times" />
                            @L["GoToMyMoves"]
                        </Button>
                    </div>
                </CardBody>
            </Card>
        </div>
    </div>
</div>

@code {
    private bool isLoading = true;
    private bool hasError = false;
    private PhotoCreditPurchase purchase;
    private int availableCredits = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var sessionId = query["session_id"];

            if (string.IsNullOrEmpty(sessionId))
            {
                hasError = true;
                isLoading = false;
                return;
            }

            // Obtener la compra por ID de sesión
            purchase = await PhotoCreditService.GetPurchaseBySessionIdAsync(sessionId);
            
            if (purchase == null || !purchase.IsCompleted)
            {
                hasError = true;
                isLoading = false;
                return;
            }

            // Obtener créditos disponibles
            availableCredits = await PhotoCreditService.GetAvailableCreditsAsync(purchase.UserId);
        }
        catch (Exception ex)
        {
            hasError = true;
            Console.Error.WriteLine($"Error loading purchase details: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}
